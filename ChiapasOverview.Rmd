---
title: "Chiapas"
author: "Juan Carlos Villaseñor"
date: "8 de enero de 2017"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
```


```{r load packages}
suppressPackageStartupMessages({
  library(rgdal)
  library(maptools)
  library(sp)
  library(raster)
  library(sp)
  library(tmap)
  library(plotly)
  library(tidyverse)
})
```

```{r load data}

mun_ids <- read.csv("./Data/mun_ids_Chiapas.csv", stringsAsFactors = F)

royacafe_data <- read.csv("./Data/royacafe_data_Chiapas.csv", stringsAsFactors = F)

clr <- royacafe_data %>% 
  mutate(Initial = as.Date(Initial, format = "%d/%m/%Y"),
         Final = as.Date(Final, format = "%d/%m/%Y")) %>% 
  group_by(Municipality) %>%
  summarize(Nobs = n()) %>%
  mutate(Municipality = as.factor(Municipality)) %>%
  rename(NOM_MUN = Municipality) %>%
  left_join(mun_ids, by = "NOM_MUN")


dir = "./Data/Spatial"

stat <- readOGR(dsn = dir, layer = "states", verbose = F)
#stat <- stat[stat$NAME == "Oaxaca",]
proj <- CRS("+proj=lcc +lat_1=17.5 +lat_2=29.5 +lat_0=0 +lon_0=-102 +x_0=2000000 +y_0=0 +datum=NAD27 +units=m +no_defs +ellps=clrk66 +nadgrids=@conus,@alaska,@ntv2_0.gsb,@ntv1_can.dat")

proj2 <- CRS("+proj=longlat +datum=NAD27")

#muni <- readOGR(dsn = dir, layer = "Municipios__2000")

muni <- readShapePoly(fn = file.path(dir, "Municipios__2000"), proj4string = proj)
muni <- muni[muni$NOM_ENT == "Chiapas", c(10,11)]
muni <- spTransform(muni, CRS("+proj=longlat +datum=NAD27"))

# Hay que corregir aqui usando una look-up table para municipios mal escritos Sun Jan 08 20:14:55 2017 ------------------------------
muni@data <- muni@data %>%
  mutate(MUN = as.integer(as.character(MUN))) %>%
  left_join(clr, by = "MUN")


## Temperature data from inifap
temp <- read.csv("./Data/inifap_data_Chiapas.csv", stringsAsFactors = F) %>% 
  mutate(Date = as.Date(Date, format = "%d/%m/%Y")) %>%
  group_by(Name, Municipality) %>%
  summarize(latitude = mean(Latitude2, na.rm = T),
            longitude = mean(Longitude2, na.rm = T),
            maxYear = max(Date),
            minYear = min(Date)) %>%
  ungroup() %>%
  mutate(minYear = as.Date("1/1/2010", format = "%d/%m/%Y"))

xy <- data.frame(X = -1*abs(temp$longitude), Y = temp$latitude)
coordinates(xy) <- c("X", "Y")
proj4string(xy) <- proj2  ## for example
res <- spTransform(xy, proj2)
b <- SpatialPointsDataFrame(coords = res, data = temp, proj4string = proj2)

# ## Temperature data from CliCom
# load("./Data/clicom_data.RData")
# 
# temp2 <- clicom_data %>%
#   mutate(date = as.Date(datenum, origin = "1970-01-01")-719529) %>%
#   group_by(id, station) %>%
#   summarize(latitude = mean(latitude, na.rm = T),
#             longitude = mean(longitude, na.rm = T),
#             maxYear = max(date),
#             minYear =min(date)) %>%
#   ungroup()
# 
# xy <- data.frame(X = temp2$longitude, Y = temp2$latitude)
# coordinates(xy) <- c("X", "Y")
# proj4string(xy) <- proj2  ## for example
# res2 <- spTransform(xy, proj2)
# c <- SpatialPointsDataFrame(coords = res2, data = temp2, proj4string = proj2)


```

## Deliverable 1 - Climate data

This contains daily data for climatic variables collected from weather stations at 2 m above the ground. Data comes from INIFAP's website at [http://clima.inifap.gob.mx/redinifap/](http://clima.inifap.gob.mx/redinifap/est.aspx?est=38213), where one can search by state, station, year, and month. This same portal has station data available for all other states, including Chiapas, Veracruz, and Guerrero, states that also produce coffee. Data were obtained by copy-pasting directly from the tables displayed in each query for the state of Oaxaca and every station listed under it. There are a total of `r length(unique(temp$Name))` stations with data that covers some point between 2007 and `r max(temp$Date)` (Fig. 1). Within that window, some stations may have gaps of missing data.

  - *Name*: the name of the station
  
  - *Municipality*: the municipality where the station is
  
  - *Latitud1*: Latitude in decimal degrees
  
  - *Longitude1*: Longitude  in decimal degrees
  
  - *Latitude2*: Latitude in DMS format
  
  - *Longitude2*: Latitude in DMS format
  
  - *Date*: Date in dd//mm/yy format (\*.csv) and YYYY/mm/dd (\*.Rdata)
  
  - *Preci*: Precipitation in mm
  
  - *Tmax*: Maximum daily temperature in °C
  
  - *Tmin*: Minimum daily temperature in °C
  
  - *Tmed*: Mean daily temperature in °C
  
  - *VVMax*: Maximum wind speed in km/h
  
  - *DVVMax*: Direction of the maximum wind speed in azimuth
  
  - *VV*: Mean wind speed in km/h
  
  - *DV*: Mean direction of wind speed in azimuth
  
  - *RadG*: Global radiation in w / m^2
  
  - *HR*: Relative humidity (%)
  
  - *ET*: Reference evapotranspiration (mm)
  
  - *EP*: Potential evapotranspiration (mm)
  
```{r, fig.cap="**Figure 1 - **Initial and final times of sampling for each station. These window of meassurements may be interrupted at different points for different stations.", fig.height = 7, fig.width=10}

temp %>%
  dplyr::select(Name, latitude, longitude, minYear, maxYear) %>%
  gather(Period, Date, -c(1:3)) %>%
  ggplot(aes(x = Date, y = Name)) +
  geom_point(aes(color = Period)) +
  geom_line() +
  theme_bw() +
  scale_color_brewer(palette = "Set1") +
  labs(x = "Date", y = "Station")

```

```{r, eval = F, fig.cap="**Figure 2 -** Initial and final times of coffee leaf rust data. These window of meassurements may be interrupted at different points for different stations.", fig.width=10}

royacafe_data %>%
  mutate(Initial = as.Date(Initial, format = c("%d/%m/%Y")),
         Final = as.Date(Final, format = c("%d/%m/%Y"))) %>%
  group_by(Municipality) %>%
  summarize(Records = n(),
            Init = min(Initial),
            Last = max(Final)) %>%
  gather(Period, Date, -c(1:2)) %>%
  ggplot(aes(x = Date, y = Municipality)) +
  geom_point(aes(color = Period)) +
  geom_line() +
  theme_bw() +
  scale_color_brewer(palette = "Set1") +
  labs(x = "Date", y = "Station")

```

## Spatial distribution of data

```{r, fig.cap="**Figure 3 -** Map of Oaxaca and municipalities. Color of municipalities represent the number of weeks (weekly reports) with available information for each municipality, also shown as text over each municipality. Red dots indicate the locations of weather stations from which data is available from INIFAP's database.", fig.width = 8}

tm_shape(muni, is.master = TRUE) +
  tm_polygons('Nobs', title='Weeks with data', auto.palette.mapping=F, text = "No CLR data") +
  tm_text("Nobs", size = 0.5) +
  tm_style_gray() +
  tm_shape(b) +
  tm_bubbles(col = "red", size = 0.25, border.col = "black") +
  tm_layout(legend.position = c("RIGHT", "TOP"))

```

